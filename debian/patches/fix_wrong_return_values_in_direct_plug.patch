Index: alsa-lib-1.0.15/src/pcm/pcm_direct.c
===================================================================
--- alsa-lib-1.0.15.orig/src/pcm/pcm_direct.c	2008-03-11 22:44:08.000000000 -0400
+++ alsa-lib-1.0.15/src/pcm/pcm_direct.c	2008-03-11 22:44:23.000000000 -0400
@@ -109,13 +109,15 @@
 	}
 	dmix->shmptr = shmat(dmix->shmid, 0, 0);
 	if (dmix->shmptr == (void *) -1) {
+		err = -errno;
 		snd_pcm_direct_shm_discard(dmix);
-		return -errno;
+		return err;
 	}
 	mlock(dmix->shmptr, sizeof(snd_pcm_direct_share_t));
 	if (shmctl(dmix->shmid, IPC_STAT, &buf) < 0) {
+		err = -errno;
 		snd_pcm_direct_shm_discard(dmix);
-		return -errno;
+		return err;
 	}
 	if (buf.shm_nattch == 1) {	/* we're the first user, clear the segment */
 		memset(dmix->shmptr, 0, sizeof(snd_pcm_direct_share_t));
@@ -128,7 +130,7 @@
 	} else {
 		if (dmix->shmptr->magic != SND_PCM_DIRECT_MAGIC) {
 			snd_pcm_direct_shm_discard(dmix);
-			return -errno;
+			return -EINVAL;
 		}
 	}
 	return 0;
